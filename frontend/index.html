<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gest√£o de Caixa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
.container { max-width: 1200px; margin: auto; }
.card { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,.1); }
h1,h2 { margin-top: 0; }
input, select, button { width: 100%; padding: 10px; margin: 5px 0; }
button { background: #2d89ef; color: #fff; border: none; cursor: pointer; border-radius: 5px; }
button:hover { background: #1b5fc4; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align: left; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media(max-width:900px){ .grid{grid-template-columns:1fr;} }
.success { background-color: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
.error { background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
.selected-product { display:flex; justify-content:space-between; margin:5px 0; padding:5px; background:#eef; border-radius:4px; }
.selected-product span { font-weight:bold; }
.selected-product button { background:#c00; color:#fff; border:none; border-radius:4px; padding:2px 6px; cursor:pointer; }
</style>
</head>

<body>
<div class="container">
<h1>üìä Gest√£o de Caixa</h1>
<div id="message"></div>

<div class="grid">

<!-- CLIENTES -->
<div class="card">
<h2>üë§ Clientes</h2>
<input id="clienteNome" placeholder="Nome do cliente">
<button onclick="addCliente()">Cadastrar</button>
<table>
<thead><tr><th>Nome</th><th></th></tr></thead>
<tbody id="clientesTabela"></tbody>
</table>
</div>

<!-- PRODUTOS -->
<div class="card">
<h2>üì¶ Produtos</h2>
<input id="produtoNome" placeholder="Nome do produto">
<input id="produtoValor" type="number" step="0.01" placeholder="Valor">
<button onclick="addProduto()">Cadastrar</button>
<table>
<thead><tr><th>Produto</th><th>Valor</th><th></th></tr></thead>
<tbody id="produtosTabela"></tbody>
</table>
</div>

</div>

<!-- VENDA -->
<div class="card">
<h2>üßæ Nova Venda</h2>
<select id="vendaCliente"></select>
<select id="vendaProduto" onchange="atualizarValorVenda()"></select>
<input id="vendaValor" readonly placeholder="Valor do produto">
<input id="vendaDesconto" type="number" step="0.01" placeholder="Desconto (R$)" oninput="calcularTotalVendaAtual()">
<button onclick="adicionarProdutoVenda()">Adicionar Produto</button>

<h3>Produtos selecionados:</h3>
<div id="produtosSelecionados"></div>

<h3>Total da venda: R$ <span id="vendaTotal">0.00</span></h3>
<button onclick="registrarVenda()">Finalizar Venda</button>
</div>

<!-- HIST√ìRICO -->
<div class="card">
<h2>üìú Hist√≥rico de Vendas</h2>
<input id="searchVendas" placeholder="Pesquisar por cliente ou produto" oninput="filtrarVendas()">
<table>
<thead>
<tr>
<th>Cliente</th>
<th>Produtos</th>
<th>Total</th>
<th>Data</th>
</tr>
</thead>
<tbody id="vendasTabela"></tbody>
</table>
</div>

<!-- CAIXA -->
<div class="card">
<h2>üí∞ Caixa</h2>
<h3>Saldo: R$ <span id="saldo">0.00</span></h3>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const API_URL = 'https://gestao-caixa-backend.onrender.com';
let clientes = [];
let produtos = [];
let vendas = [];
let vendaAtual = [];

// =======================
// MENSAGEM
// =======================
function showMessage(msg, type='success'){
  const div = document.getElementById('message');
  div.innerHTML = `<div class="${type}">${msg}</div>`;
  setTimeout(()=>{ div.innerHTML=''; }, 3000);
}

// =======================
// CLIENTES
// =======================
async function fetchClientes(){
  try {
    const res = await fetch(`${API_URL}/clientes`);
    clientes = await res.json();
    renderClientes();
  } catch(e){ console.error('Erro ao buscar clientes:', e); }
}

async function addCliente(){
  if(!clienteNome.value) return;
  try {
    const res = await fetch(`${API_URL}/clientes`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({nome: clienteNome.value})
    });
    if(res.ok){ clienteNome.value=''; await fetchClientes(); showMessage('Cliente cadastrado!'); }
    else showMessage('Erro ao cadastrar cliente','error');
  } catch(e){ showMessage('Erro de rede ao cadastrar cliente','error'); }
}

async function deleteCliente(id){
  if(!confirm('Deseja deletar este cliente?')) return;
  try {
    const res = await fetch(`${API_URL}/clientes/${id}`, { method:'DELETE' });
    if(res.ok){ await fetchClientes(); showMessage('Cliente deletado!'); }
    else showMessage('Erro ao deletar cliente','error');
  } catch(e){ showMessage('Erro de rede ao deletar cliente','error'); }
}

function renderClientes(){
  clientesTabela.innerHTML='';
  vendaCliente.innerHTML='<option value="">Selecione o cliente</option>';
  clientes.forEach(c=>{
    clientesTabela.innerHTML += `<tr>
      <td>${c.nome}</td>
      <td><button onclick="deleteCliente(${c.id})">‚ùå</button></td>
    </tr>`;
    vendaCliente.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
  });
}

// =======================
// PRODUTOS
// =======================
async function fetchProdutos(){
  try {
    const res = await fetch(`${API_URL}/produtos`);
    const data = await res.json();
    produtos = data.map(p=>({id:p.id, nome:p.nome, valor:parseFloat(p.valor)}));
    renderProdutos();
  } catch(e){ console.error('Erro ao buscar produtos:', e); }
}

async function addProduto(){
  if(!produtoNome.value || !produtoValor.value) return;
  try {
    const res = await fetch(`${API_URL}/produtos`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({nome:produtoNome.value, valor:parseFloat(produtoValor.value)})
    });
    if(res.ok){ produtoNome.value=''; produtoValor.value=''; await fetchProdutos(); showMessage('Produto cadastrado!'); }
    else showMessage('Erro ao cadastrar produto','error');
  } catch(e){ showMessage('Erro de rede ao cadastrar produto','error'); }
}

async function deleteProduto(id){
  if(!confirm('Deseja deletar este produto?')) return;
  try {
    const res = await fetch(`${API_URL}/produtos/${id}`, { method:'DELETE' });
    if(res.ok){ await fetchProdutos(); showMessage('Produto deletado!'); }
    else showMessage('Erro ao deletar produto','error');
  } catch(e){ showMessage('Erro de rede ao deletar produto','error'); }
}

function renderProdutos(){
  produtosTabela.innerHTML='';
  vendaProduto.innerHTML='<option value="">Selecione o produto</option>';
  produtos.forEach(p=>{
    produtosTabela.innerHTML += `<tr>
      <td>${p.nome}</td>
      <td>R$ ${p.valor.toFixed(2)}</td>
      <td><button onclick="deleteProduto(${p.id})">‚ùå</button></td>
    </tr>`;
    vendaProduto.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
  });
}

// =======================
// VENDAS M√öLTIPLAS
// =======================
function atualizarValorVenda(){
  const produtoId = parseInt(vendaProduto.value);
  const p = produtos.find(pr=>pr.id===produtoId);
  vendaValor.value = p ? p.valor.toFixed(2) : '';
}

function calcularTotalVendaAtual(){
  const total = vendaAtual.reduce((s,i)=>s+i.total,0);
  document.getElementById('vendaTotal').innerText = total.toFixed(2);
}

function adicionarProdutoVenda(){
  const produtoId = parseInt(vendaProduto.value);
  const desconto = parseFloat(vendaDesconto.value)||0;
  const p = produtos.find(pr=>pr.id===produtoId);
  if(!p) return showMessage('Selecione um produto','error');
  let total = p.valor - desconto;
  if(total<0) total=0;
  vendaAtual.push({produto:p.nome, valor:p.valor, desconto, total});
  renderProdutosSelecionados();
  vendaDesconto.value='';
  vendaValor.value='';
}

function removerProdutoVenda(index){
  vendaAtual.splice(index,1);
  renderProdutosSelecionados();
}

function renderProdutosSelecionados(){
  const div = document.getElementById('produtosSelecionados');
  div.innerHTML='';
  vendaAtual.forEach((item,i)=>{
    const el = document.createElement('div');
    el.className='selected-product';
    el.innerHTML=`<span>${item.produto} - R$ ${item.total.toFixed(2)}</span>
                  <button onclick="removerProdutoVenda(${i})">‚ùå</button>`;
    div.appendChild(el);
  });
  calcularTotalVendaAtual();
}

// =======================
// REGISTRAR VENDA E GERAR COMPROVANTE
// =======================
async function registrarVenda(){
  const clienteId = parseInt(vendaCliente.value);
  const cliente = clientes.find(c=>c.id===clienteId);
  if(!cliente) return showMessage('Selecione um cliente','error');
  if(vendaAtual.length===0) return showMessage('Adicione pelo menos 1 produto','error');

  try {
    const res = await fetch(`${API_URL}/vendas`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({cliente: cliente.nome, itens: vendaAtual})
    });
    if(res.ok){
      const data = await res.json(); // <- converte a resposta para JSON
      gerarComprovantePDF({cliente: cliente.nome, itens: data.itens || vendaAtual, codigo: data.codigo});
      vendaAtual=[]; renderProdutosSelecionados(); vendaCliente.value='';
      fetchVendas();
      showMessage('Venda registrada com sucesso!');
    } else showMessage('Erro ao registrar venda','error');
  } catch(e){ showMessage('Erro de rede ao registrar venda','error'); }
}

// =======================
// COMPROVANTE
// =======================
function gerarComprovantePDF(venda){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const codigoVenda = venda.codigo || Math.floor(100000 + Math.random()*900000);

  doc.setFontSize(16);
  doc.text('Comprovante de Venda', 105, 20, {align:'center'});

  const rectWidth = 50;
  const rectHeight = 15;
  const rectX = (doc.internal.pageSize.getWidth() - rectWidth)/2;
  const rectY = 30;
  doc.setDrawColor(0);
  doc.setFillColor(200,200,255);
  doc.rect(rectX, rectY, rectWidth, rectHeight,'F');

  doc.setTextColor(0);
  doc.setFontSize(14);
  doc.text(`#${codigoVenda}`, doc.internal.pageSize.getWidth()/2, rectY+rectHeight/1.5, {align:'center'});

  doc.setFontSize(12);
  doc.text(`Cliente: ${venda.cliente}`, 20, 60);
  doc.text(`Data: ${new Date().toLocaleString()}`, 20, 70);

  let startY = 90;
  doc.text('Produto', 20, startY);
  doc.text('Valor', 90, startY);
  doc.text('Desconto', 130, startY);
  doc.text('Total', 170, startY);
  startY+=10;

  venda.itens.forEach(item=>{
    doc.text(item.produto, 20, startY);
    doc.text(`R$ ${item.valor.toFixed(2)}`, 90, startY);
    doc.text(`R$ ${item.desconto.toFixed(2)}`, 130, startY);
    doc.text(`R$ ${item.total.toFixed(2)}`, 170, startY);
    startY+=10;
  });

  const totalGeral = venda.itens.reduce((s,i)=>s+i.total,0);
  startY+=10;
  doc.text(`TOTAL: R$ ${totalGeral.toFixed(2)}`, 130, startY);
  doc.text('Obrigado pela sua compra!', 105, startY+20, {align:'center'});

  doc.save(`comprovante_${venda.cliente}_${codigoVenda}.pdf`);
}

// =======================
// HIST√ìRICO E CAIXA
// =======================
async function fetchVendas(){
  try {
    const res = await fetch(`${API_URL}/vendas`);
    vendas = await res.json();
    renderVendas();
  } catch(e){ console.error('Erro ao buscar vendas:', e); }
}

function renderVendas(){
  vendasTabela.innerHTML='';
  let saldoTotal=0;
  vendas.forEach(v=>{
    const produtosStr = v.itens.map(i=>`${i.produto} (R$ ${i.total.toFixed(2)})`).join(', ');
    const totalVenda = v.itens.reduce((s,i)=>s+i.total,0);
    saldoTotal += totalVenda;
    vendasTabela.innerHTML += `<tr>
      <td>${v.cliente}</td>
      <td>${produtosStr}</td>
      <td>R$ ${totalVenda.toFixed(2)}</td>
      <td>${new Date(v.data).toLocaleString()}</td>
    </tr>`;
  });
  document.getElementById('saldo').innerText = saldoTotal.toFixed(2);
}

function filtrarVendas(){
  const filtro = searchVendas.value.toLowerCase();
  const linhas = vendasTabela.getElementsByTagName('tr');
  Array.from(linhas).forEach(l=>{
    const cliente = l.cells[0].innerText.toLowerCase();
    const produtos = l.cells[1].innerText.toLowerCase();
    l.style.display = (cliente.includes(filtro)||produtos.includes(filtro)) ? '' : 'none';
  });
}

// =======================
// INIT
// =======================
function init(){
  fetchClientes();
  fetchProdutos();
  fetchVendas();
}

init();
</script>
</body>
</html>
