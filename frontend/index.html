<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>GestÃ£o de Caixa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
.container { max-width: 1200px; margin: auto; }
.card { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,.1); }
h1,h2 { margin-top: 0; }
input, select, button { width: 100%; padding: 10px; margin: 5px 0; }
button { background: #2d89ef; color: #fff; border: none; cursor: pointer; border-radius: 5px; }
button:hover { background: #1b5fc4; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border-bottom: 1px solid #ddd; padding: 8px; }
.entrada { color: green; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media(max-width:900px){ .grid{grid-template-columns:1fr;} }
</style>
</head>
<body>

<div class="container">
<h1>ðŸ“Š GestÃ£o de Caixa</h1>

<div class="grid">
  <!-- CLIENTES -->
  <div class="card">
    <h2>ðŸ‘¤ Clientes</h2>
    <input id="clienteNome" placeholder="Nome do cliente">
    <button onclick="addCliente()">Cadastrar</button>
    <table>
      <thead><tr><th>Nome</th><th></th></tr></thead>
      <tbody id="clientesTabela"></tbody>
    </table>
  </div>

  <!-- PRODUTOS -->
  <div class="card">
    <h2>ðŸ“¦ Produtos</h2>
    <input id="produtoNome" placeholder="Nome do produto">
    <input id="produtoValor" type="number" step="0.01" placeholder="Valor">
    <button onclick="addProduto()">Cadastrar</button>
    <table>
      <thead><tr><th>Produto</th><th>Valor</th><th></th></tr></thead>
      <tbody id="produtosTabela"></tbody>
    </table>
  </div>
</div>

<!-- VENDA -->
<div class="card">
<h2>ðŸ§¾ Nova Venda</h2>
<select id="vendaCliente"></select>
<select id="vendaProduto" onchange="atualizarValorVenda()"></select>
<input id="vendaValor" readonly placeholder="Valor do produto">
<input id="vendaDesconto" type="number" step="0.01" placeholder="Desconto (R$)" oninput="calcularTotal()">
<input id="vendaTotal" readonly placeholder="Total da venda">
<button onclick="registrarVenda()">Confirmar Venda</button>
</div>

<!-- HISTÃ“RICO -->
<div class="card">
<h2>ðŸ“œ HistÃ³rico de Vendas</h2>
<table>
<thead>
<tr><th>Cliente</th><th>Produto</th><th>Valor</th><th>Desconto</th><th>Total</th><th>Data</th></tr>
</thead>
<tbody id="vendasTabela"></tbody>
</table>
</div>

<!-- CAIXA -->
<div class="card">
<h2>ðŸ’° Caixa</h2>
<h3>Saldo: R$ <span id="saldo">0.00</span></h3>
<table>
<thead><tr><th>DescriÃ§Ã£o</th><th>Valor</th></tr></thead>
<tbody id="movTabela"></tbody>
</table>
</div>

<script>
const API_URL = 'https://gestao-caixa-backend.onrender.com';

let clientes = [];
let produtos = [];
let vendas = [];

// =======================
// CLIENTES
// =======================
async function fetchClientes() {
  const res = await fetch(`${API_URL}/clientes`);
  clientes = await res.json();
  renderClientes();
}

async function addCliente() {
  const nome = document.getElementById('clienteNome').value.trim();
  if (!nome) return;
  const res = await fetch(`${API_URL}/clientes`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({nome})
  });
  if(res.ok){ document.getElementById('clienteNome').value=''; await fetchClientes(); }
  else alert('Erro ao cadastrar cliente');
}

function renderClientes() {
  const tabela = document.getElementById('clientesTabela');
  const select = document.getElementById('vendaCliente');
  tabela.innerHTML = '';
  select.innerHTML = '<option value="">Selecione o cliente</option>';
  clientes.forEach(c => {
    tabela.innerHTML += `<tr><td>${c.nome}</td></tr>`;
    select.innerHTML += `<option value="${c.nome}">${c.nome}</option>`;
  });
}

// =======================
// PRODUTOS
// =======================
async function fetchProdutos() {
  const res = await fetch(`${API_URL}/produtos`);
  produtos = await res.json();
  renderProdutos();
}

async function addProduto() {
  const nome = document.getElementById('produtoNome').value.trim();
  const valor = parseFloat(document.getElementById('produtoValor').value);
  if (!nome || isNaN(valor)) return;
  const res = await fetch(`${API_URL}/produtos`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({nome, valor})
  });
  if(res.ok){ document.getElementById('produtoNome').value=''; document.getElementById('produtoValor').value=''; await fetchProdutos(); }
  else alert('Erro ao cadastrar produto');
}

function renderProdutos() {
  const tabela = document.getElementById('produtosTabela');
  const select = document.getElementById('vendaProduto');
  tabela.innerHTML = '';
  select.innerHTML = '<option value="">Selecione o produto</option>';
  produtos.forEach(p => {
    tabela.innerHTML += `<tr><td>${p.nome}</td><td>R$ ${parseFloat(p.valor).toFixed(2)}</td></tr>`;
    select.innerHTML += `<option value="${p.nome}">${p.nome}</option>`;
  });
}

// =======================
// VENDA
// =======================
function atualizarValorVenda() {
  const nomeProduto = document.getElementById('vendaProduto').value;
  const produto = produtos.find(p => p.nome === nomeProduto);
  document.getElementById('vendaValor').value = produto ? produto.valor.toFixed(2) : '';
  document.getElementById('vendaDesconto').value = '';
  document.getElementById('vendaTotal').value = produto ? produto.valor.toFixed(2) : '';
}

function calcularTotal() {
  const valor = parseFloat(document.getElementById('vendaValor').value) || 0;
  let desconto = parseFloat(document.getElementById('vendaDesconto').value) || 0;
  if (desconto > valor) desconto = valor;
  document.getElementById('vendaTotal').value = (valor - desconto).toFixed(2);
}

async function registrarVenda() {
  const cliente = document.getElementById('vendaCliente').value;
  const produtoNome = document.getElementById('vendaProduto').value;
  const produto = produtos.find(p => p.nome === produtoNome);
  const desconto = parseFloat(document.getElementById('vendaDesconto').value) || 0;
  const total = parseFloat(document.getElementById('vendaTotal').value) || 0;

  if(!cliente || !produto) return alert('Selecione cliente e produto');

  const res = await fetch(`${API_URL}/vendas`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      cliente,
      produto: produto.nome,
      valor: produto.valor,
      desconto,
      total
    })
  });

  if(res.ok){
    document.getElementById('vendaCliente').value='';
    document.getElementById('vendaProduto').value='';
    document.getElementById('vendaValor').value='';
    document.getElementById('vendaDesconto').value='';
    document.getElementById('vendaTotal').value='';
    await fetchVendas();
  } else alert('Erro ao registrar venda');
}

// =======================
// VENDAS
// =======================
async function fetchVendas() {
  const res = await fetch(`${API_URL}/vendas`);
  vendas = await res.json();
  renderVendas();
}

function renderVendas() {
  const tabela = document.getElementById('vendasTabela');
  const movTabela = document.getElementById('movTabela');
  tabela.innerHTML=''; movTabela.innerHTML='';
  let saldo = 0;

  vendas.forEach(v=>{
    tabela.innerHTML += `<tr>
      <td>${v.cliente}</td><td>${v.produto}</td><td>R$ ${parseFloat(v.valor).toFixed(2)}</td>
      <td>R$ ${parseFloat(v.desconto).toFixed(2)}</td><td>R$ ${parseFloat(v.total).toFixed(2)}</td>
      <td>${new Date(v.data).toLocaleString()}</td>
    </tr>`;
    saldo += parseFloat(v.total);
    movTabela.innerHTML += `<tr><td>Venda - ${v.produto}</td><td class="entrada">R$ ${parseFloat(v.total).toFixed(2)}</td></tr>`;
  });

  document.getElementById('saldo').innerText = saldo.toFixed(2);
}

// =======================
// INIT
// =======================
async function init() {
  await fetchClientes();
  await fetchProdutos();
  await fetchVendas();
}

init();
</script>

</body>
</html>
