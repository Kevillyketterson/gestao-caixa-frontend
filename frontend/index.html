<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gest√£o de Caixa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
.container { max-width: 1200px; margin: auto; }
.card { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,.1); }
h1,h2 { margin-top: 0; }
input, select, button { width: 100%; padding: 10px; margin: 5px 0; }
button { background: #2d89ef; color: #fff; border: none; cursor: pointer; border-radius: 5px; }
button:hover { background: #1b5fc4; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border-bottom: 1px solid #ddd; padding: 8px; }
.entrada { color: green; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media(max-width:900px){ .grid{grid-template-columns:1fr;} }
</style>
</head>

<body>
<div class="container">
<h1>üìä Gest√£o de Caixa</h1>

<div class="grid">

<!-- CLIENTES -->
<div class="card">
<h2>üë§ Clientes</h2>
<input id="clienteNome" placeholder="Nome do cliente">
<button onclick="addCliente()">Cadastrar</button>
<table>
<thead><tr><th>Nome</th><th></th></tr></thead>
<tbody id="clientesTabela"></tbody>
</table>
</div>

<!-- PRODUTOS -->
<div class="card">
<h2>üì¶ Produtos</h2>
<input id="produtoNome" placeholder="Nome do produto">
<input id="produtoValor" type="number" step="0.01" placeholder="Valor">
<button onclick="addProduto()">Cadastrar</button>
<table>
<thead><tr><th>Produto</th><th>Valor</th><th></th></tr></thead>
<tbody id="produtosTabela"></tbody>
</table>
</div>

</div>

<!-- VENDA -->
<div class="card">
<h2>üßæ Nova Venda</h2>
<select id="vendaCliente"></select>
<select id="vendaProduto" onchange="atualizarValorVenda()"></select>

<input id="vendaValor" readonly placeholder="Valor do produto">
<input id="vendaDesconto" type="number" step="0.01" placeholder="Desconto (R$)" oninput="calcularTotal()">
<input id="vendaTotal" readonly placeholder="Total da venda">

<button onclick="registrarVenda()">Confirmar Venda</button>
</div>

<!-- HIST√ìRICO -->
<div class="card">
<h2>üìú Hist√≥rico de Vendas</h2>
<table>
<thead>
<tr>
<th>Cliente</th>
<th>Produto</th>
<th>Valor</th>
<th>Desconto</th>
<th>Total</th>
<th>Data</th>
</tr>
</thead>
<tbody id="vendasTabela"></tbody>
</table>
</div>

<!-- CAIXA -->
<div class="card">
<h2>üí∞ Caixa</h2>
<h3>Saldo: R$ <span id="saldo">0.00</span></h3>
<table>
<thead><tr><th>Descri√ß√£o</th><th>Valor</th></tr></thead>
<tbody id="movTabela"></tbody>
</table>
</div>

</div>

<script>
const API_URL = 'https://gestao-caixa-backend.onrender.com';

// Estado
let clientes = [];
let produtos = [];
let vendas = [];

// =======================
// CLIENTES
// =======================
async function fetchClientes(){
  const res = await fetch(`${API_URL}/clientes`);
  clientes = await res.json();
  renderClientes();
}

async function addCliente(){
  if(!clienteNome.value) return;
  const res = await fetch(`${API_URL}/clientes`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({nome: clienteNome.value})
  });
  if(res.ok){
    clienteNome.value='';
    await fetchClientes();
  } else {
    alert('Erro ao cadastrar cliente');
  }
}

function renderClientes(){
  clientesTabela.innerHTML='';
  vendaCliente.innerHTML='<option value="">Selecione o cliente</option>';
  clientes.forEach(c=>{
    clientesTabela.innerHTML += `<tr>
      <td>${c.nome}</td>
      <td><button onclick="deleteCliente(${c.id})">‚ùå</button></td>
    </tr>`;
    vendaCliente.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
  });
}

function deleteCliente(id){
  clientes = clientes.filter(c=>c.id!==id);
  renderClientes();
}

// =======================
// PRODUTOS
// =======================
async function fetchProdutos(){
  const res = await fetch(`${API_URL}/produtos`);
  const data = await res.json();
  produtos = data.map(p=>({
    id: p.id,
    nome: p.nome,
    valor: parseFloat(p.valor)
  }));
  renderProdutos();
}

async function addProduto(){
  if(!produtoNome.value || !produtoValor.value) return;
  const res = await fetch(`${API_URL}/produtos`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({nome: produtoNome.value, valor: parseFloat(produtoValor.value)})
  });
  if(res.ok){
    produtoNome.value='';
    produtoValor.value='';
    await fetchProdutos();
  } else {
    alert('Erro ao cadastrar produto');
  }
}

function renderProdutos(){
  produtosTabela.innerHTML='';
  vendaProduto.innerHTML='<option value="">Selecione o produto</option>';
  produtos.forEach(p=>{
    produtosTabela.innerHTML += `<tr>
      <td>${p.nome}</td>
      <td>R$ ${p.valor.toFixed(2)}</td>
      <td><button onclick="deleteProduto(${p.id})">‚ùå</button></td>
    </tr>`;
    vendaProduto.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
  });
}

function deleteProduto(id){
  produtos = produtos.filter(p=>p.id!==id);
  renderProdutos();
}

// =======================
// VENDAS
// =======================
async function fetchVendas(){
  const res = await fetch(`${API_URL}/vendas`);
  vendas = await res.json();
  renderVendas();
}

function atualizarValorVenda(){
  const produtoId = parseInt(vendaProduto.value);
  const p = produtos.find(pr=>pr.id===produtoId);
  vendaValor.value = p ? p.valor.toFixed(2) : '';
  vendaDesconto.value='';
  vendaTotal.value=vendaValor.value;
}

function calcularTotal(){
  const valor = parseFloat(vendaValor.value)||0;
  let desconto = parseFloat(vendaDesconto.value)||0;
  if(desconto>valor){ desconto=valor; vendaDesconto.value=valor.toFixed(2);}
  vendaTotal.value=(valor-desconto).toFixed(2);
}

async function registrarVenda(){
  const clienteId = parseInt(vendaCliente.value);
  const cliente = clientes.find(c=>c.id===clienteId);

  const produtoId = parseInt(vendaProduto.value);
  const p = produtos.find(pr=>pr.id===produtoId);

  if(!cliente || !p) return alert('Selecione cliente e produto');

  const desconto = parseFloat(vendaDesconto.value)||0;
  const total = parseFloat(vendaTotal.value);

  try {
    const res = await fetch(`${API_URL}/vendas`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        cliente: cliente.nome,
        produto: p.nome,
        valor: p.valor,
        desconto,
        total
      })
    });
    if(res.ok){
      vendaCliente.value=''; vendaProduto.value=''; vendaValor.value=''; vendaDesconto.value=''; vendaTotal.value='';
      await fetchVendas();
    } else {
      const err = await res.json();
      console.error('Erro do backend:', err);
      alert('Erro ao registrar venda');
    }
  } catch(e){
    console.error('Falha na requisi√ß√£o:', e);
    alert('Erro ao registrar venda (falha de rede)');
  }
}

// =======================
// HIST√ìRICO E CAIXA
// =======================
function renderVendas(){
  vendasTabela.innerHTML='';
  let saldoTotal=0;
  vendas.forEach(v=>{
    saldoTotal += v.total;
    vendasTabela.innerHTML += `<tr>
      <td>${v.cliente}</td>
      <td>${v.produto}</td>
      <td>R$ ${parseFloat(v.valor).toFixed(2)}</td>
      <td>R$ ${parseFloat(v.desconto).toFixed(2)}</td>
      <td>R$ ${parseFloat(v.total).toFixed(2)}</td>
      <td>${new Date(v.data).toLocaleString()}</td>
    </tr>`;
  });
  document.getElementById('saldo').innerText = saldoTotal.toFixed(2);
}

// =======================
// INIT
// =======================
function init(){
  fetchClientes();
  fetchProdutos();
  fetchVendas();
}

init();
</script>
</body>
</html>
